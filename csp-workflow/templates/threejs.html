<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ config.ui.title if config and config.ui and config.ui.title else "Three.js CSP Office" }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/threejs.css') }}" />
  </head>
  <body>
    <div class="flash-title">
      <a href="https://github.com/Photon1c/pulselinestudio/tree/main" target="_blank" rel="noopener noreferrer" class="flash-title__link">
        <span class="flash-title__text">Pulseline Studio</span>
      </a>
      <span class="flash-title__orb flash-title__orb--left"></span>
      <span class="flash-title__orb flash-title__orb--right"></span>
    </div>
    <div class="top-hint">Press I for instructions</div>
    <button class="overlay-toggle" id="overlayToggle" aria-label="Toggle dashboard">◧</button>
    <div class="overlay" id="overlay">
      <section class="panel panel--controls">
        <header class="panel__header">
          <h2>Workflow Controls</h2>
          <button class="panel__collapse" id="controlsCollapse" aria-label="Collapse workflow controls">&#8211;</button>
        </header>
        <div class="control-grid">
          <label>
            Assistants
            <input
              type="number"
              id="agentsInput"
              min="{{ config.limits.min_agents if config and config.limits else 1 }}"
              max="{{ config.limits.max_agents if config and config.limits else 24 }}"
              value="{{ config.defaults.num_agents if config and config.defaults else 8 }}"
            />
          </label>
          <label>
            Tasks
            <input
              type="number"
              id="tasksInput"
              min="{{ config.limits.min_tasks if config and config.limits else 10 }}"
              max="{{ config.limits.max_tasks if config and config.limits else 50000 }}"
              value="{{ config.defaults.num_tasks if config and config.defaults else 220 }}"
              step="10"
            />
          </label>
          <label>
            Max Minutes
            <input
              type="number"
              id="minutesInput"
              min="{{ config.limits.min_minutes if config and config.limits else 60 }}"
              max="{{ config.limits.max_minutes if config and config.limits else 720 }}"
              value="{{ config.defaults.max_minutes if config and config.defaults else 480 }}"
              step="30"
            />
          </label>
          <label class="mode-select-wrapper">
            Mode
            <div class="tooltip-container">
              <select id="modeSelect">
                {% for key, value in scenarios.items() %}
                <option value="{{ key }}" {% if config.defaults.mode == key %}selected{% endif %} data-description="{{ value.description }}">
                  {{ value.label }}
                </option>
                {% endfor %}
              </select>
              <span class="tooltip" id="modeTooltip"></span>
            </div>
          </label>
        </div>
        <div class="actions">
          <button class="btn" id="playBtn">Run</button>
          <button class="btn secondary" id="pauseBtn">Pause</button>
          <button class="btn accent" id="spikeBtn">Workload Spike</button>
        </div>
        <label class="slider-label">
          Simulation Speed
          <span id="speedValue">1.0x</span>
          <input
            type="range"
            id="speedSlider"
            min="0.5"
            max="8"
            step="0.1"
            value="{{ config.ui.speed_default if config and config.ui and config.ui.speed_default else 1 }}"
          />
        </label>
        <div class="control-hint">
          <p class="legend">Utilization: calm → focus → overloaded</p>
          <button class="instructions-pill" id="openInstructionsBtn" type="button">Press I for instructions</button>
        </div>
        {% set ready_status = config.ui.status_ready if config and config.ui and config.ui.status_ready else "Ready · Balanced Ops" %}
        {% set ready_parts = ready_status.split("·") %}
        <p class="status-pill" id="statusPill">
          <span>{{ ready_parts[0].strip() }}</span>
          {% if ready_parts|length > 1 %} · {{ ready_parts[1].strip() }}{% endif %}
        </p>
        <!-- Removed duplicate backlog metrics from controls to avoid confusion -->
      </section>

      <section class="panel metrics-panel">
        <div class="panel__header">
          <h3>Live Metrics</h3>
          <button class="panel__collapse" id="collapseMetricsBtn"></button>
        </div>
        <div class="metrics-panel__content">
          <div class="metrics" id="metricsPanel">
          <div class="metric">
            <span>Avg Utilization</span>
            <strong id="metric-util">0%</strong>
          </div>
          <div class="metric">
            <span>Backlog Minutes</span>
            <strong id="metric-backlog">0</strong>
          </div>
          <div class="metric">
            <span>Backlog Tasks</span>
            <strong id="metric-backlog-count">0</strong>
          </div>
          <div class="metric">
            <span>Tasks / Assistant</span>
            <strong id="metric-tasks-assistant">0</strong>
          </div>
          <div class="metric">
            <span>Arrival Rate</span>
            <strong id="metric-arrival">0/min</strong>
          </div>
          <div class="metric">
            <span>Throughput</span>
            <strong id="metric-throughput">0%</strong>
          </div>
          <div class="metric">
            <span>Active Assistants</span>
            <strong id="metric-assistants">0 / 0</strong>
          </div>
          <div class="metric">
            <span>Belt Speed</span>
            <strong id="metric-belt">1x</strong>
          </div>
          <div class="metric">
            <span>Flow Delta</span>
            <strong id="metric-flow">0</strong>
          </div>
          </div>
        </div>
        <label class="slider-label compact">
          Belt Speed
          <span id="beltValue">
            {{ config.ui.belt_default if config and config.ui and config.ui.belt_default else 1 }}x
          </span>
          <input
            type="range"
            id="beltSlider"
            min="0.5"
            max="2.5"
            step="0.1"
            value="{{ config.ui.belt_default if config and config.ui and config.ui.belt_default else 1 }}"
          />
        </label>
        <div class="cycle-bar">
          <div class="cycle-bar__label">Production Cycle</div>
          <div class="cycle-bar__track">
            <div class="cycle-bar__fill" id="cycleBarFill"></div>
          </div>
        </div>
        <div class="assistants-panel" id="assistantsPanel">
          <p>Assistants will appear here after you run a simulation.</p>
        </div>
      </section>

      <!-- Instructions Modal -->
      <div class="modal-overlay" id="instructionsModal" aria-hidden="true">
        <div class="modal">
          <div class="modal__header">
            <h3>Navigation & Controls</h3>
            <button class="modal__close" id="closeInstructionsBtn" aria-label="Close instructions">×</button>
          </div>
          <div class="modal__content">
            <h4>Camera Controls</h4>
            <p>
              <strong>Mouse:</strong> Drag to orbit · Scroll to zoom · Right-drag to pan
            </p>
            <p>
              <strong>Keyboard:</strong> WASD to strafe · Q/E to elevate · R to reset camera
            </p>
            <h4>Simulation Controls</h4>
            <p>
              Use Run/Pause buttons or press <strong>P</strong> to pause/resume the simulation.
            </p>
            <p>
              Press <strong>I</strong> to open/close this help window.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="viewport"></div>
    <div class="fps-counter" id="fpsCounter">FPS: 0</div>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.155.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.155.0/examples/jsm/"
        }
      }
    </script>
    <script>
      window.SCENARIO_META = {{ scenarios|tojson }};
      window.APP_CONFIG = {{ config|tojson }};
    </script>
    <script type="module" src="{{ url_for('static', filename='js/threejs_scene.js') }}"></script>
  </body>
</html>
